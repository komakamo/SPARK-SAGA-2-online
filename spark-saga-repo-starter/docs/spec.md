# Spec.md
# SPARK SAGA（仮） 仕様書 v1.0
作成日: 2025-10-25 / 対象ブランチ: `dev`（公開は`main`）  
前提: **予算0円** / **Julesの実行回数: 1日100回まで** / コーディングは全てJulesが担当

---

## 0. 目的（Doneの定義）
- GitHub Pages デプロイURLを開くと**即起動**（初回ロード≤6秒、2回目≤3秒、4G回線想定）
- **PWA対応**：インストール可、**オフライン起動**可（最後に成功したビルドを起動）
- **MVP**：プレイ時間6〜10時間、6地域＋拠点、主人公3、敵20＋ボス5、スキル30〜40、陣形6、クエスト24（汎用15＋主人公専用9）
- **セーブ**：ローカル3スロット＋JSON入出力（ドラッグ&ドロップ）
- **アクセシビリティ**：文字サイズ、色覚配慮モード、点滅軽減、入力リマップ
- **法務**：コードはMIT/Apache-2.0等、アセットは**CC0/CC-BYのみ**（全記録は`CREDITS.md`）
- **自動テスト**：戦闘式/ドロップ/イベント条件など**20本以上**の単体テストが緑

---

## 1. 配布・非機能要件
- **プラットフォーム**：Web（PC/スマホ）
- **配布**：GitHub Pages（主）／itch.ioミラー（静的ビルドそのまま）※無料
- **対応ブラウザ**：Chrome/Edge/Firefox/iOS Safari（最新＋1メジャー）
- **パフォーマンス**：60FPS目標／30FPS下限。画像WebP、音Ogg、遅延読込、スプライトシート化
- **バンドル上限**（初期）：アプリコード<2.0MB（音・画像除く）
- **テレメトリ**（任意・オプトインのみ）：起動数、クラッシュ、ボス敗北回数、平均戦闘ターン

---

## 2. コア体験（SaGa的要素の再解釈）
1) **多主人公×非線形**：序盤選択で中盤以降の主要イベント分岐  
2) **閃き（Spark）**：戦闘中に条件一致→新スキルを即発動＆習得  
3) **陣形×武器系統×LP**：陣形補正、武器適性、**LP**による戦術的緊張感  
4) **イベントランク（ER）**：戦闘数/主要フラグで世界の出現テーブルが段階変化  
5) **軽い経済変動**（任意ON）：地域需給で価格±10%（OFF可）

---

## 3. コンテンツ・範囲（MVP）
- **地域**：6（拠点都市1＋周辺5）
- **主人公**：3（各ルートに専用導入＋専用クエ×3）
- **敵**：通常20種、ボス5体
- **武器系統**：9（剣/大剣/小剣/槍/斧/棍棒/弓/体術/杖・術）
- **スキル**：各系統3〜5、計30〜40
- **陣形**：6
- **クエスト**：汎用15＋主人公専用9（計24）
- **BGM**：10〜12曲（CC0/CC-BY）

---

## 4. 世界観・主人公・地域
### 4.1 主人公（初期ビルド）
- **レイ＝ヴァン（剣/小剣）**：失われた王家の指輪の行方を追う護衛。俊敏・器用、LP低め  
- **ミラ＝サイ（槍/弓）**：砂海の遊牧学者。古塔の星図から災異を察知。知力高  
- **ドルガン（斧/棍棒/体術）**：廃坑の労務頭。鉱山利権と魔獣出現の黒幕を追う。体力・腕力高

### 4.2 地域（6）
1) **星港アストラ（拠点）**：ギルド/鍛冶/図書館/依頼板  
2) **砂海バザール**：交易/闘技場、砂獣・盗賊、多段攻撃が有効  
3) **霧の森林**：毒/混乱、自然/霊タグが多い  
4) **鉱脈の谷**：甲殻・機械に打撃有利、落盤ギミック  
5) **朽ちた水都**：水棲・雷弱点、開閉式の水門ギミック  
6) **星見の古塔**：終盤、敵配置がERで変化、最終ボス前哨戦

---

## 5. 進行・イベント・派閥
- **ER段階**：ER0/1/2/3  
  - 上昇条件例：勝利数（20/50/90）＋主要フラグ  
  - 効果：低難度クエ削除→上位クエ出現、店売り更新、敵編成強化
- **派閥**：星港商会/鉱山組合/祠守/傭兵団（評判-100〜+100）  
  - 評判±10毎に店割引/依頼開放/同盟支援/敵対等を更新
- **周回**：クリア後に**図鑑（敵/スキル）**・一部評判を引継ぎ、演出や出現比率が微変化

---

## 6. 戦闘システム
### 6.1 能力値
- **基礎**：HP / **LP** / 腕力 / 体力 / 器用 / 素早 / 知力 / 意志 / 運
- **派生**：攻撃力（武器×腕力/器用補正）、術力（杖×知力）、防御力（体力）、回避（素早）、抵抗（意志）

### 6.2 リソース
- **WP**（武技）/ **JP**（術技）：自然回復0（装備・陣形・スキルで例外）
- **LP**：HP0→LP-1で立ち上がる（デフォで**各戦闘1回**）。LP0で完全戦闘不能

### 6.3 行動順
- **行動値** = `素早 × Rand(0.85〜1.15) + スキル速度補正`（**小さいほど先行**）

### 6.4 命中・回避・会心
- **命中率** = `基礎命中（スキル） + 命中補正（器用/素早） − 相手回避`
- **会心率上限**：30%（基礎＋スキル補正＋装備OP）

### 6.5 ダメージ式
- 物理  
基本D = (武器攻 × A) + (腕力 × B) + スキル威力
実D = 基本D × (1 - 敵防御 / (敵防御 + K)) × 耐性補正 × Rand(0.9〜1.1)

diff
コードをコピーする
- 術  
基本D = (杖補正 × C) + (知力 × D) + 術式威力
実D = 基本D × (1 - 敵抵抗 / (敵抵抗 + Ks)) × 属性耐性 × Rand(0.9〜1.1)

yaml
コードをコピーする
- 既定係数（`/data/balance.json`で変更可）：`A=1.0, B=0.7, K=50, C=1.0, D=0.9, Ks=50`

### 6.6 状態異常（代表）
- 毒（%DoT）/出血（ヒット毎DoT）/麻痺（行動不能確率）/スタン（1T停止）/睡眠（被弾で解除）/混乱（味方誤射）/沈黙（術封印）/石化（超高耐性・解除困難）/凍結（受ける打撃増）/炎上（火DoT）  
- 付与判定：`命中式 → 耐性タグ補正 → 最終確率`。持続はターン/解除条件タグ管理

### 6.7 陣形（6）
| ID | 名称 | 主効果（前列/後列/全体） |
|---|---|---|
| crane_wing | 鶴翼 | 後列被ダメ0.85、弓/術命中+5% |
| tiger_claw | 虎陣 | 前列与ダメ1.15、被ダメ1.10 |
| square | 方円 | 全員被ダメ0.90、行動値+5% |
| fish_scale | 魚鱗 | 先頭挑発↑、カウンター率+10% |
| wild_geese | 雁行 | 行動値-10%（先行）、会心+5% |
| twin_star | 双星 | **2人連携発生率+15%**、後列与ダメ0.9 |

### 6.8 閃き（Spark）
- **トリガ**：未習得系統の武器で攻撃／敵タグ一致（甲殻/飛行/霊など）／HP25%以下／仲間戦闘不能／特定陣形
- **確率**：`基礎(2〜6%) × 系統適性補正 × 敵タグ一致補正 × 主人公補正`  
- **効果**：新スキルを**即時発動**→以後恒常習得（以後は通常消費で使用）

### 6.9 敵AI
- **重み選択**：HP/耐性/状態/プレイヤー構成/派閥評判  
- **フェーズ**：ボスはHP70%/40%で行動セット切替（強化/召喚/デバフ）

---

## 7. 成長・装備・クラフト・経済
- **クラスレス成長**：戦闘後、**使用した系統**に応じ基礎値が確率上昇（0〜15%）。上限は`/data/balance.json`
- **装備**：武器・盾・頭・体・アクセ×2。OP例：`crit+2, wp_regen+1, fire_res+10`
- **クラフト**：素材＋設計書でOP抽選（プールと重みはJSON管理）
- **経済**：価格 = `基準 × (1 + 需給指数/100)`、指数は地域ごと-10〜+10（±10%）、ON/OFF可能

---

## 8. 画面/UX/入力
- **タイトル**：New / Continue / Import / Settings / Credits
- **フィールド**：8方向移動、会話、宝箱、採取、イベントトリガ
- **戦闘UI**：上=敵隊列と状態 中=ログ 下=コマンド 右=PT一覧（HP/LP/WP/JP）
- **編成/装備**：ドラッグ&ドロップ、陣形選択、推奨装備
- **クエログ**：メイン/派閥/地域でフィルタ、進捗タグ
- **設定**：文字サイズ、配色（ライト/ダーク/色覚D/N/P）、操作（KB/Pad/タッチ）、演出簡略化
- **入力**：矢印/WASD、決定=Enter/Space、戻る=Esc、メニュー=Tab、ターゲット切替=Q/E  
- **モバイル**：仮想D-Pad＋大ボタン3（決定/戻る/メニュー）  
- **セーブ**：オート（戦闘/エリア移動後）、スロット3＋JSON I/O

---

## 9. データ駆動設計
### 9.1 ディレクトリ構成（論理）
/public # 画像/音/フォント（CC0/CC-BY）
/src # 実装（Jules担当）
/data # すべてJSON（スキーマ下記）
/tests # 単体/E2E
.github/workflows # CI（ビルド/テスト/Pages）
index.html

pgsql
コードをコピーする

### 9.2 ID/参照
- IDは`snake_case`文字列。相互参照は**ビルド時に検証**し、不整合はCI失敗

### 9.3 JSONスキーマ（抜粋サンプル）
- **skill.json**
```json
{
  "id": "sword_moonlight",
  "name": "月光",
  "category": "weapon",
  "weapon_type": "sword",
  "cost": {"wp": 3, "jp": 0},
  "power": 28,
  "speed_mod": -5,
  "crit_mod": 0.05,
  "tags": ["slash", "single"],
  "inflict": [{"status": "bleed", "chance": 0.2}],
  "spark_conditions": [{"enemy_tag": "flying"}, {"low_hp": true}],
  "learn_source": ["spark", "scroll"],
  "animation": "slash_moon",
  "desc": "素早く斬りつける先行技。"
}
weapon.json

json
コードをコピーする
{
  "id": "iron_sword",
  "type": "sword",
  "atk": 12,
  "op": ["crit+2", "wp_regen+1"],
  "desc": "扱いやすい剣。"
}
enemy.json

json
コードをコピーする
{
  "id": "sand_scorpion",
  "name": "砂蠍",
  "level": 6,
  "tags": ["carapace"],
  "stats": {"hp": 120, "lp": 2, "str": 12, "vit": 10, "dex": 8, "agi": 7, "int": 4, "wil": 6, "luk": 5},
  "resist": {"slash": 0.8, "pierce": 1.2, "blunt": 1.0, "fire": 0.9, "ice": 1.1, "shock": 1.2},
  "skills": ["tail_sting", "sand_blast"],
  "ai": {"style": "aggressive",
         "phase":[{"hp_leq":0.7,"prefer":["tail_sting"]},{"hp_leq":0.4,"prefer":["sand_blast"]}]},
  "drops": [{"item":"scorpion_shell","rate":0.3}]
}
formation.json

json
コードをコピーする
{
  "id":"crane_wing",
  "name":"鶴翼",
  "row_mod":{
    "front":{"dmg_out":1.0,"hit":0.0},
    "back":{"dmg_in":0.85,"hit":0.05}
  },
  "team_mod":{"agi":0.0,"crit":0.0}
}
event.json（分岐式）

json
コードをコピーする
{
  "id":"guild_lost_ring",
  "when":{"region":"astro_port","er_gte":0,"flags_not":["ring_found"]},
  "nodes":[
    {"type":"dialog","text":"護衛を探している、とギルドの受付が言う。"},
    {"type":"choice","options":[
      {"label":"依頼を受ける","set_flags":["lost_ring_accepted"],"goto":"accept"},
      {"label":"断る","goto":"end"}
    ]},
    {"id":"accept","type":"quest_start","quest_id":"lost_ring"}
  ]
}
quest.json：id, title, giver, steps[], rewards, faction_impact

shop.json：id, region, list[], price_mod, demand_index

faction.json：id, name, thresholds[], effects[]

balance.json：全係数、成長確率、ER閾値の集中管理

10. コンテンツ表（MVP抜粋）
10.1 武器系統×代表スキル（例）
剣：斬撃/月光/燕返し（会心↑）

大剣：轟断（防御一部無視）/地割（列）/重破（スタン付与）

小剣：刺突（出血）/影走り（回避↑後攻撃）/連突（多段）

槍：霞突（速度↑）/貫穿（貫通）/竜牙（飛行特効）

斧：薪割（命中↓高威力）/旋風斬（周囲）/裂甲（甲殻特効）

棍棒：粉砕（打撃↑）/脳震（スタン）/守護印（被ダメ↓）

弓：速射（2回）/狙撃（先行高命中）/束縛矢（行動値+）

体術：連撃（多段）/受け流し（カウンター）/気合（WP回復）

杖/術：火弾/氷槍/雷鎖/風壁/石肌/沈黙の霧

10.2 敵（例20）
砂獣、砂サソリ、砂盗、狼霊、樹鬼、霧蛇、甲殻兵、坑夫傀儡、水都衛兵、泥鰻、機巧蜘蛛、浮遊眼、亡者騎士、祠守の影、雷クラゲ、塔の番犬、星幽体、石像魔、装甲巨人、災異の苗床

10.3 ボス（5）
闘技場覇者／砂海の巨蠍／堕ちた聖騎／水門の主／星喰みの核

11. QA/テスト
単体：ダメージ（境界/高防御/耐性1.5x）、命中/回避/会心の分布（1万試行）、ドロップ率偏差（±1%）、イベント条件（旗立て/未立て）

E2E：新規→最初のボス撃破を自動化（仮想入力）

パフォーマンス：画像最適化、バッチ描画、パーティクル上限

Lighthouse：PWA installable/Performance≥70/Accessibility≥90

12. アクセシビリティ
文字サイズ3段階（100/120/140%）

色覚モード（Deuter/Proto/Tritan）

点滅演出OFF（フラッシュ抑制）

入力リマップ（主要操作に限定）

13. アセット・ライセンス（0円運用）
画像/音：CC0/CC-BYのみ、出典URL・作者・改変有無をCREDITS.md管理

禁止：商用不可/NC、SA強制、出典不明、二次配布不可系

取り込み時CIでLICENSEファイルの存在を検査

14. CI/CD・運用
ブランチ：dev（開発）→main（公開）

CI：pushでビルド/テスト/Pagesプレビュー、mainマージで公開

リリース：SemVer（v0.1.0=MVP、v1.0.0=正式）

ロールバック：GitHub Pages で前回成功ビルドに戻す

15. スケジュール（4週目安）
W1：雛形/PWA/移動/会話/戦闘最小/1ボス/セーブ

W2：敵12/スキル20/陣形4/クエ10/主人公2/UI整備

W3：敵20/スキル35/陣形6/主人公3/ER/i18n下地

W4：BGM/最適化/アクセシビリティ/チュートリアル/公開


17. リスク・対策
スコープ膨張 → MVP表を固定、ERは必要に応じ3段階へ縮退

バランス難 → オート戦闘シミュで係数調整、敵HP/与ダメ一括倍率

モバイル負荷 → 解像度スケール、エフェクト簡略化

ライセンス事故 → 取り込み時CIで検査、CREDITS.md運用

18. 仕上げチェックリスト
 オフライン起動（機内モード）

 初回/再訪のロード時間基準達成

 アクセシビリティ設定の保存

 スマホ縦横/PCフルHDでUI崩れなし

 CREDITS.mdとライセンス記載完了

 v0.1.0タグ付け＆リリースノート

19. 付録A：イベントスクリプト・ノード型仕様（最小）
type：dialog（会話）/choice（選択）/quest_start/quest_update/battle/reward/set_flag/goto

when：region/er_gte/flags_has/party_has/item_hasなど論理AND

nodes[]：id省略時は順次実行、gotoでラベルジャンプ

20. 付録B：テレメトリ・イベント（オプトイン）
session_start, crash, boss_attempt, boss_defeat, stage_time

送信はユーザ同意時のみ、匿名ID、個人情報なし

21. 用語集
ER：Event Rank（世界更新の段階）

LP：Life Point（戦闘不能に直結する命のストック）

Spark：戦闘中の新スキルひらめき
